---
name: "Check for Semantic PR and Commit Titles"

on:
  pull_request:
    types: [ opened, reopened, synchronize, edited ]
  workflow_call:
    inputs:
      COMMITS_HISTORY:
        description: 'Number of commits to consider, starting with most recent (e.g. 1 = only look at most recent).'
        # 250 appears to be the limit of `gh api --paginate $COMMITS_URL`
        default: 250
        required: false
        type: number

env:
  PR_TITLE: ${{ github.event.pull_request.title }}
  COMMITS_URL: ${{ github.event.pull_request.commits_url }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  SEMANTIC_PATTERN: |-
__PATTERN__

jobs:
  main:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        ref: ${{ github.event.pull_request.head.sha }}
    - name: Fetch PR Details
      shell: bash
      run: |
        echo "COMMITS_HISTORY = ${{ inputs.COMMITS_HISTORY }}"
        if (( ${{ inputs.COMMITS_HISTORY}} != 0 )); then
          json=$( gh api --paginate $COMMITS_URL )
          echo 'commits<<EOF' >> $GITHUB_ENV
          echo $json | jq --raw-output '.[] | [.sha, (.commit.message | split("\n") | first)] | join(" ")'
          echo $json | jq --raw-output '.[] | [.sha, (.commit.message | split("\n") | first)] | join(" ")' | tail -"${{ inputs.COMMITS_HISTORY }}" >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV
        fi
    - name: Check PR Title and Commit Title(s)
      shell: bash
      run: |
__SCRIPT__
